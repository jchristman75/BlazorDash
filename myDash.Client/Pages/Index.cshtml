@page "/"
@using System.Reflection
@using Microsoft.AspNetCore.Blazor.RenderTree
@using myDash.Shared
@inject HttpClient Http

<head>
    <style>
        .card {
            background-color: transparent;
            background-image: linear-gradient(to bottom, rgba(149, 87, 29, 0.2) 0%, rgba(125, 185, 232, 0) 100%);
            background-repeat: repeat;
            border-radius: 10px;
            padding: 0px;
            margin-bottom: 15px;
        }
    </style>
</head>

<section class="container">
    <div class="row info-panel">
        @CreateDynamicComponent();
    </div>
</section>

@functions {
    WidgetSettings[] widgets;
    protected override async Task OnInitAsync()
    {
        widgets = await Http.GetJsonAsync<WidgetSettings[]>("api/SampleData/widgets");
        StateHasChanged();
    }

    RenderFragment CreateDynamicComponent() => builder =>
    {
        if (widgets == null) return;

        var assm = Assembly.GetExecutingAssembly();
        var assmName = assm.GetName().Name;

        foreach (var widget in widgets)
        {
            var widgetType = Type.GetType($"{assmName}.Widgets.{widget.widget}");
            if (widgetType != null)
            {
                AddWidget(builder, widgetType, widget.parameters);
            }
        }
    };

    private static void AddWidget(RenderTreeBuilder builder, Type widget, Dictionary<string,object> parameters )
    {
        var seq = 0;
        builder.OpenComponent(seq, widget);
        foreach (var param in parameters)
        {
            seq++;
            builder.AddAttribute(seq, param.Key, param.Value);
        }
        builder.CloseComponent();
    }

}
